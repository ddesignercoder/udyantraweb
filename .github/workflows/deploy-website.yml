name: Deploy Laravel Project to BigRock (FTP)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Install PHP & Composer
      - name: Install PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      # 3️⃣ Install Composer Dependencies (Optimized for Production)
      - name: Composer Install
        run: |
          composer install --no-dev --optimize-autoloader

      # 4️⃣ Install Node & Build Assets
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # - name: Install NPM Packages & Build
      #   run: |
      #     npm install
      #     npm run build

      # 5️⃣ Prepare Deployment Folder
      - name: Create deployment artifact
        run: |
          mkdir deploy
          rsync -av --exclude="node_modules" \
                    --exclude=".git" \
                    --exclude=".github" \
                    --exclude="tests" \
                    --exclude="storage/logs/*" \
                    --exclude="storage/framework/views/*" \
                    ./ deploy/

      # 6️⃣ Deploy to BigRock using FTP
      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.3
        with:
          server: ${{ secrets.BIGROCK_HOST }}
          username: ${{ secrets.BIGROCK_USER }}
          password: ${{ secrets.BIGROCK_FTP_PASS }}
          local-dir: ./deploy/
          server-dir: /home1/${{ secrets.BIGROCK_USER }}/demo/udyantra/staging/public/
          dry-run: false
          dangerous-clean-slate: false   # deletes only changed files
